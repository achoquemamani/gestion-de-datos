-- Ac√° van los create de los procedures y los EXEC de ellos



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_VARIANTE
AS
BEGIN
INSERT INTO HARAKIRI.VARIANTE (VARIANTE_TIPO_VARIANTE_CODIGO,VARIANTE_NOMBRE )
SELECT DISTINCT T.TIPO_VARIANTE_CODIGO,PRODUCTO_VARIANTE
FROM  gd_esquema.Maestra M JOIN HARAKIRI.TIPO_VARIANTE T ON M.PRODUCTO_TIPO_VARIANTE = T.TIPO_VARIANTE_VALOR WHERE PRODUCTO_VARIANTE IS NOT NULL

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.VARIANTE)
PRINT('Datos migrados a la tabla HARAKIRI.VARIANTE. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO


GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_TIPO_VARIANTE
AS
BEGIN
INSERT INTO HARAKIRI.TIPO_VARIANTE (TIPO_VARIANTE_VALOR)
SELECT DISTINCT PRODUCTO_TIPO_VARIANTE AS TIPO_VARIANTE_VALOR
FROM gd_esquema.Maestra WHERE PRODUCTO_TIPO_VARIANTE IS NOT NULL

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.TIPO_VARIANTE)
PRINT('Datos migrados a la tabla HARAKIRI.TIPO_VARIANTE. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_MARCA
AS
BEGIN
INSERT INTO HARAKIRI.MARCA (MARCA_NOMBRE)
SELECT DISTINCT PRODUCTO_MARCA AS MARCA_NOMBRE
FROM gd_esquema.Maestra WHERE PRODUCTO_MARCA IS NOT NULL

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.MARCA)
PRINT('Datos migrados a la tabla HARAKIRI.MARCA. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_CATEGORIA
AS
BEGIN
INSERT INTO HARAKIRI.CATEGORIA (CATEGORIA_NOMBRE)
SELECT DISTINCT PRODUCTO_CATEGORIA AS CATEGORIA_NOMBRE
FROM gd_esquema.Maestra WHERE PRODUCTO_CATEGORIA IS NOT NULL

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.CATEGORIA)
PRINT('Datos migrados a la tabla HARAKIRI.MARCA. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_MATERIAL
AS
BEGIN
INSERT INTO HARAKIRI.MATERIAL (MATERIAL_NOMBRE)
SELECT DISTINCT PRODUCTO_MATERIAL AS MATERIAL_NOMBRE
FROM gd_esquema.Maestra WHERE PRODUCTO_MATERIAL IS NOT NULL

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.MATERIAL)
PRINT('Datos migrados a la tabla HARAKIRI.MATERIAL. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_PRODUCTO
AS
BEGIN
INSERT INTO HARAKIRI.PRODUCTO
SELECT DISTINCT MA.PRODUCTO_CODIGO AS PRODUCTO_CODIGO,
 M.MARCA_CODIGO AS PRODUCTO_MARCA_CODIGO,MT.MATERIAL_CODIGO AS  PRODUCTO_MATERIAL_CODIGO ,
  CA.CATEGORIA_CODIGO AS  PRODUCTO_CATEGORIA_CODIGO ,
 MA.PRODUCTO_NOMBRE AS PRODUCTO_NOMBRE, MA.PRODUCTO_DESCRIPCION AS  PRODUCTO_DESCRIPCION
FROM gd_esquema.Maestra MA JOIN HARAKIRI.MARCA M ON MA.PRODUCTO_MARCA = M.MARCA_NOMBRE 
JOIN HARAKIRI.MATERIAL MT ON MA.PRODUCTO_MATERIAL = MT.MATERIAL_NOMBRE 
JOIN HARAKIRI.CATEGORIA CA ON MA.PRODUCTO_CATEGORIA = CA.CATEGORIA_NOMBRE 
WHERE PRODUCTO_CODIGO IS NOT NULL

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.PRODUCTO)
PRINT('Datos migrados a la tabla HARAKIRI.PRODUCTO. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_PRODUCTO_VARIANTE
AS
BEGIN
INSERT INTO HARAKIRI.PRODUCTO_VARIANTE
SELECT DISTINCT MA.PRODUCTO_VARIANTE_CODIGO AS PRODUCTO_VARIANTE_CODIGO,
 P.PRODUCTO_CODIGO AS PRODUCTO_CODIGO,V.VARIANTE_CODIGO AS  VARIANTE_CODIGO ,
 max(COMPRA_PRODUCTO_PRECIO) AS PRECIO_ACTUAL_COMPRA
,max(VENTA_PRODUCTO_PRECIO) AS PRECIO_ACTUAL_VENTA



FROM gd_esquema.Maestra MA JOIN HARAKIRI.PRODUCTO P ON MA.PRODUCTO_CODIGO = P.PRODUCTO_CODIGO 
JOIN HARAKIRI.VARIANTE V ON V.VARIANTE_NOMBRE = MA.PRODUCTO_VARIANTE 
WHERE PRODUCTO_VARIANTE_CODIGO IS NOT NULL
group by PRODUCTO_VARIANTE_CODIGO ,P.PRODUCTO_CODIGO,V.VARIANTE_CODIGO
order by PRODUCTO_VARIANTE_CODIGO

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.PRODUCTO_VARIANTE)
PRINT('Datos migrados a la tabla HARAKIRI.PRODUCTO_VARIANTE. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO



GO
CREATE PROCEDURE HARAKIRI.MIGRAR_TABLA_VENTA_POR_PRODUCTO
AS
BEGIN
INSERT INTO HARAKIRI.VENTA_POR_PRODUCTO
SELECT  V.VENTA_CODIGO AS VENTA_CODIGO,
 P.PRODUCTO_VARIANTE_CODIGO AS PRODUCTO_VARIANTE_CODIGO,
 MA.VENTA_PRODUCTO_CANTIDAD AS PRODUCTO_CANTIDAD
,MA.VENTA_PRODUCTO_CANTIDAD*MA.VENTA_PRODUCTO_PRECIO AS PRODUCTO_PRECIO_TOTAL



FROM gd_esquema.Maestra MA JOIN HARAKIRI.VENTA V ON MA.VENTA_CODIGO = V.VENTA_CODIGO 
JOIN HARAKIRI.PRODUCTO_VARIANTE P ON P.PRODUCTO_VARIANTE_CODIGO = MA.PRODUCTO_VARIANTE_CODIGO 

order by VENTA_CODIGO,PRODUCTO_VARIANTE_CODIGO

DECLARE @CANTIDAD_REGISTROS NVARCHAR(255)
SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM HARAKIRI.VENTA_POR_PRODUCTO)
PRINT('Datos migrados a la tabla HARAKIRI.VENTA_POR_PRODUCTO. Nuevas filas: ' + @CANTIDAD_REGISTROS)

END
GO






EXEC  HARAKIRI.MIGRAR_TABLA_MARCA
EXEC  HARAKIRI.MIGRAR_TABLA_MATERIAL
EXEC  HARAKIRI.MIGRAR_TABLA_CATEGORIA
EXEC  HARAKIRI.MIGRAR_TABLA_TIPO_VARIANTE
EXEC  HARAKIRI.MIGRAR_TABLA_VARIANTE
EXEC   HARAKIRI.MIGRAR_TABLA_PRODUCTO
EXEC   HARAKIRI.MIGRAR_TABLA_PRODUCTO_VARIANTE 
/*  EXEC   HARAKIRI.MIGRAR_TABLA_VENTA_POR_PRODUCTO */